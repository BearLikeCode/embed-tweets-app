{"ast":null,"code":"\"use strict\";\n\nvar __createBinding = this && this.__createBinding || (Object.create ? function (o, m, k, k2) {\n  if (k2 === undefined) k2 = k;\n  var desc = Object.getOwnPropertyDescriptor(m, k);\n\n  if (!desc || (\"get\" in desc ? !m.__esModule : desc.writable || desc.configurable)) {\n    desc = {\n      enumerable: true,\n      get: function () {\n        return m[k];\n      }\n    };\n  }\n\n  Object.defineProperty(o, k2, desc);\n} : function (o, m, k, k2) {\n  if (k2 === undefined) k2 = k;\n  o[k2] = m[k];\n});\n\nvar __setModuleDefault = this && this.__setModuleDefault || (Object.create ? function (o, v) {\n  Object.defineProperty(o, \"default\", {\n    enumerable: true,\n    value: v\n  });\n} : function (o, v) {\n  o[\"default\"] = v;\n});\n\nvar __importStar = this && this.__importStar || function (mod) {\n  if (mod && mod.__esModule) return mod;\n  var result = {};\n  if (mod != null) for (var k in mod) if (k !== \"default\" && Object.prototype.hasOwnProperty.call(mod, k)) __createBinding(result, mod, k);\n\n  __setModuleDefault(result, mod);\n\n  return result;\n};\n\nvar __importDefault = this && this.__importDefault || function (mod) {\n  return mod && mod.__esModule ? mod : {\n    \"default\": mod\n  };\n};\n\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\nexports.RequestHandlerHelper = void 0;\n\nconst https_1 = require(\"https\");\n\nconst settings_1 = require(\"../settings\");\n\nconst TweetStream_1 = __importDefault(require(\"../stream/TweetStream\"));\n\nconst types_1 = require(\"../types\");\n\nconst zlib = __importStar(require(\"zlib\"));\n\nclass RequestHandlerHelper {\n  constructor(requestData) {\n    this.requestData = requestData;\n    this.requestErrorHandled = false;\n    this.responseData = [];\n  }\n  /* Request helpers */\n\n\n  get hrefPathname() {\n    const url = this.requestData.url;\n    return url.hostname + url.pathname;\n  }\n\n  isCompressionDisabled() {\n    return !this.requestData.compression || this.requestData.compression === 'identity';\n  }\n\n  isFormEncodedEndpoint() {\n    return this.requestData.url.href.startsWith('https://api.twitter.com/oauth/');\n  }\n  /* Error helpers */\n\n\n  createRequestError(error) {\n    if (settings_1.TwitterApiV2Settings.debug) {\n      settings_1.TwitterApiV2Settings.logger.log('Request error:', error);\n    }\n\n    return new types_1.ApiRequestError('Request failed.', {\n      request: this.req,\n      error\n    });\n  }\n\n  createPartialResponseError(error, abortClose) {\n    const res = this.res;\n    let message = `Request failed with partial response with HTTP code ${res.statusCode}`;\n\n    if (abortClose) {\n      message += ' (connection abruptly closed)';\n    } else {\n      message += ' (parse error)';\n    }\n\n    return new types_1.ApiPartialResponseError(message, {\n      request: this.req,\n      response: this.res,\n      responseError: error,\n      rawContent: Buffer.concat(this.responseData).toString()\n    });\n  }\n\n  formatV1Errors(errors) {\n    return errors.map(_ref => {\n      let {\n        code,\n        message\n      } = _ref;\n      return `${message} (Twitter code ${code})`;\n    }).join(', ');\n  }\n\n  formatV2Error(error) {\n    return `${error.title}: ${error.detail} (see ${error.type})`;\n  }\n\n  createResponseError(_ref2) {\n    let {\n      res,\n      data,\n      rateLimit,\n      code\n    } = _ref2;\n\n    var _a;\n\n    if (settings_1.TwitterApiV2Settings.debug) {\n      settings_1.TwitterApiV2Settings.logger.log(`Request failed with code ${code}, data:`, data);\n      settings_1.TwitterApiV2Settings.logger.log('Response headers:', res.headers);\n    } // Errors formatting.\n\n\n    let errorString = `Request failed with code ${code}`;\n\n    if ((_a = data === null || data === void 0 ? void 0 : data.errors) === null || _a === void 0 ? void 0 : _a.length) {\n      const errors = data.errors;\n\n      if ('code' in errors[0]) {\n        errorString += ' - ' + this.formatV1Errors(errors);\n      } else {\n        errorString += ' - ' + this.formatV2Error(data);\n      }\n    }\n\n    return new types_1.ApiResponseError(errorString, {\n      code,\n      data,\n      headers: res.headers,\n      request: this.req,\n      response: res,\n      rateLimit\n    });\n  }\n  /* Response helpers */\n\n\n  getResponseDataStream(res) {\n    if (this.isCompressionDisabled()) {\n      return res;\n    }\n\n    const contentEncoding = (res.headers['content-encoding'] || 'identity').trim().toLowerCase();\n\n    if (contentEncoding === 'br') {\n      const brotli = zlib.createBrotliDecompress({\n        flush: zlib.constants.BROTLI_OPERATION_FLUSH,\n        finishFlush: zlib.constants.BROTLI_OPERATION_FLUSH\n      });\n      res.pipe(brotli);\n      return brotli;\n    }\n\n    if (contentEncoding === 'gzip') {\n      const gunzip = zlib.createGunzip({\n        flush: zlib.constants.Z_SYNC_FLUSH,\n        finishFlush: zlib.constants.Z_SYNC_FLUSH\n      });\n      res.pipe(gunzip);\n      return gunzip;\n    }\n\n    if (contentEncoding === 'deflate') {\n      const inflate = zlib.createInflate({\n        flush: zlib.constants.Z_SYNC_FLUSH,\n        finishFlush: zlib.constants.Z_SYNC_FLUSH\n      });\n      res.pipe(inflate);\n      return inflate;\n    }\n\n    return res;\n  }\n\n  detectResponseType(res) {\n    var _a, _b; // Auto parse if server responds with JSON body\n\n\n    if (((_a = res.headers['content-type']) === null || _a === void 0 ? void 0 : _a.includes('application/json')) || ((_b = res.headers['content-type']) === null || _b === void 0 ? void 0 : _b.includes('application/problem+json'))) {\n      return 'json';\n    } // f-e oauth token endpoints\n    else if (this.isFormEncodedEndpoint()) {\n      return 'url';\n    }\n\n    return 'text';\n  }\n\n  getParsedResponse(res) {\n    const data = this.responseData;\n    const mode = this.requestData.forceParseMode || this.detectResponseType(res);\n\n    if (mode === 'buffer') {\n      return Buffer.concat(data);\n    } else if (mode === 'text') {\n      return Buffer.concat(data).toString();\n    } else if (mode === 'json') {\n      const asText = Buffer.concat(data).toString();\n      return asText.length ? JSON.parse(asText) : undefined;\n    } else if (mode === 'url') {\n      const asText = Buffer.concat(data).toString();\n      const formEntries = {};\n\n      for (const [item, value] of new URLSearchParams(asText)) {\n        formEntries[item] = value;\n      }\n\n      return formEntries;\n    } else {\n      // mode === 'none'\n      return undefined;\n    }\n  }\n\n  getRateLimitFromResponse(res) {\n    let rateLimit = undefined;\n\n    if (res.headers['x-rate-limit-limit']) {\n      rateLimit = {\n        limit: Number(res.headers['x-rate-limit-limit']),\n        remaining: Number(res.headers['x-rate-limit-remaining']),\n        reset: Number(res.headers['x-rate-limit-reset'])\n      };\n\n      if (this.requestData.rateLimitSaver) {\n        this.requestData.rateLimitSaver(rateLimit);\n      }\n    }\n\n    return rateLimit;\n  }\n  /* Request event handlers */\n\n\n  onSocketEventHandler(reject, socket) {\n    socket.on('close', this.onSocketCloseHandler.bind(this, reject));\n  }\n\n  onSocketCloseHandler(reject) {\n    this.req.removeAllListeners('timeout');\n    const res = this.res;\n\n    if (res) {\n      // Response ok, res.close/res.end can handle request ending\n      return;\n    }\n\n    if (!this.requestErrorHandled) {\n      return reject(this.createRequestError(new Error('Socket closed without any information.')));\n    } // else: other situation\n\n  }\n\n  requestErrorHandler(reject, requestError) {\n    var _a, _b;\n\n    (_b = (_a = this.requestData).requestEventDebugHandler) === null || _b === void 0 ? void 0 : _b.call(_a, 'request-error', {\n      requestError\n    });\n    this.requestErrorHandled = true;\n    reject(this.createRequestError(requestError));\n  }\n\n  timeoutErrorHandler() {\n    this.requestErrorHandled = true;\n    this.req.destroy(new Error('Request timeout.'));\n  }\n  /* Response event handlers */\n\n\n  classicResponseHandler(resolve, reject, res) {\n    this.res = res;\n    const dataStream = this.getResponseDataStream(res); // Register the response data\n\n    dataStream.on('data', chunk => this.responseData.push(chunk));\n    dataStream.on('end', this.onResponseEndHandler.bind(this, resolve, reject));\n    dataStream.on('close', this.onResponseCloseHandler.bind(this, resolve, reject)); // Debug handlers\n\n    if (this.requestData.requestEventDebugHandler) {\n      this.requestData.requestEventDebugHandler('response', {\n        res\n      });\n      res.on('aborted', error => this.requestData.requestEventDebugHandler('response-aborted', {\n        error\n      }));\n      res.on('error', error => this.requestData.requestEventDebugHandler('response-error', {\n        error\n      }));\n      res.on('close', () => this.requestData.requestEventDebugHandler('response-close', {\n        data: this.responseData\n      }));\n      res.on('end', () => this.requestData.requestEventDebugHandler('response-end'));\n    }\n  }\n\n  onResponseEndHandler(resolve, reject) {\n    const rateLimit = this.getRateLimitFromResponse(this.res);\n    let data;\n\n    try {\n      data = this.getParsedResponse(this.res);\n    } catch (e) {\n      reject(this.createPartialResponseError(e, false));\n      return;\n    } // Handle bad error codes\n\n\n    const code = this.res.statusCode;\n\n    if (code >= 400) {\n      reject(this.createResponseError({\n        data,\n        res: this.res,\n        rateLimit,\n        code\n      }));\n      return;\n    }\n\n    if (settings_1.TwitterApiV2Settings.debug) {\n      settings_1.TwitterApiV2Settings.logger.log(`[${this.requestData.options.method} ${this.hrefPathname}]: Request succeeds with code ${this.res.statusCode}`);\n      settings_1.TwitterApiV2Settings.logger.log('Response body:', data);\n    }\n\n    resolve({\n      data,\n      headers: this.res.headers,\n      rateLimit\n    });\n  }\n\n  onResponseCloseHandler(resolve, reject) {\n    const res = this.res;\n\n    if (res.aborted) {\n      // Try to parse the request (?)\n      try {\n        this.getParsedResponse(this.res); // Ok, try to resolve normally the request\n\n        return this.onResponseEndHandler(resolve, reject);\n      } catch (e) {\n        // Parse error, just drop with content\n        return reject(this.createPartialResponseError(e, true));\n      }\n    }\n\n    if (!res.complete) {\n      return reject(this.createPartialResponseError(new Error('Response has been interrupted before response could be parsed.'), true));\n    } // else: end has been called\n\n  }\n\n  streamResponseHandler(resolve, reject, res) {\n    const code = res.statusCode;\n\n    if (code < 400) {\n      if (settings_1.TwitterApiV2Settings.debug) {\n        settings_1.TwitterApiV2Settings.logger.log(`[${this.requestData.options.method} ${this.hrefPathname}]: Request succeeds with code ${res.statusCode} (starting stream)`);\n      }\n\n      const dataStream = this.getResponseDataStream(res); // HTTP code ok, consume stream\n\n      resolve({\n        req: this.req,\n        res: dataStream,\n        originalResponse: res,\n        requestData: this.requestData\n      });\n    } else {\n      // Handle response normally, can only rejects\n      this.classicResponseHandler(() => undefined, reject, res);\n    }\n  }\n  /* Wrappers for request lifecycle */\n\n\n  debugRequest() {\n    const url = this.requestData.url;\n    settings_1.TwitterApiV2Settings.logger.log(`[${this.requestData.options.method} ${this.hrefPathname}]`, this.requestData.options);\n\n    if (url.search) {\n      settings_1.TwitterApiV2Settings.logger.log('Request parameters:', [...url.searchParams.entries()].map(_ref3 => {\n        let [key, value] = _ref3;\n        return `${key}: ${value}`;\n      }));\n    }\n\n    if (this.requestData.body) {\n      settings_1.TwitterApiV2Settings.logger.log('Request body:', this.requestData.body);\n    }\n  }\n\n  buildRequest() {\n    var _a;\n\n    const url = this.requestData.url;\n    const auth = url.username ? `${url.username}:${url.password}` : undefined;\n    const headers = (_a = this.requestData.options.headers) !== null && _a !== void 0 ? _a : {};\n\n    if (this.requestData.compression === true || this.requestData.compression === 'brotli') {\n      headers['accept-encoding'] = 'br;q=1.0, gzip;q=0.8, deflate;q=0.5, *;q=0.1';\n    } else if (this.requestData.compression === 'gzip') {\n      headers['accept-encoding'] = 'gzip;q=1, deflate;q=0.5, *;q=0.1';\n    } else if (this.requestData.compression === 'deflate') {\n      headers['accept-encoding'] = 'deflate;q=1, *;q=0.1';\n    }\n\n    if (settings_1.TwitterApiV2Settings.debug) {\n      this.debugRequest();\n    }\n\n    this.req = (0, https_1.request)({ ...this.requestData.options,\n      // Define URL params manually, addresses dependencies error https://github.com/PLhery/node-twitter-api-v2/issues/94\n      host: url.hostname,\n      port: url.port || undefined,\n      path: url.pathname + url.search,\n      protocol: url.protocol,\n      auth,\n      headers\n    });\n  }\n\n  registerRequestEventDebugHandlers(req) {\n    var _this = this;\n\n    req.on('close', () => this.requestData.requestEventDebugHandler('close'));\n    req.on('abort', () => this.requestData.requestEventDebugHandler('abort'));\n    req.on('socket', socket => {\n      this.requestData.requestEventDebugHandler('socket', {\n        socket\n      });\n      socket.on('error', error => this.requestData.requestEventDebugHandler('socket-error', {\n        socket,\n        error\n      }));\n      socket.on('connect', () => this.requestData.requestEventDebugHandler('socket-connect', {\n        socket\n      }));\n      socket.on('close', withError => this.requestData.requestEventDebugHandler('socket-close', {\n        socket,\n        withError\n      }));\n      socket.on('end', () => this.requestData.requestEventDebugHandler('socket-end', {\n        socket\n      }));\n      socket.on('lookup', function () {\n        for (var _len = arguments.length, data = new Array(_len), _key = 0; _key < _len; _key++) {\n          data[_key] = arguments[_key];\n        }\n\n        return _this.requestData.requestEventDebugHandler('socket-lookup', {\n          socket,\n          data\n        });\n      });\n      socket.on('timeout', () => this.requestData.requestEventDebugHandler('socket-timeout', {\n        socket\n      }));\n    });\n  }\n\n  makeRequest() {\n    this.buildRequest();\n    return new Promise((resolve, reject) => {\n      const req = this.req; // Handle request errors\n\n      req.on('error', this.requestErrorHandler.bind(this, reject));\n      req.on('socket', this.onSocketEventHandler.bind(this, reject));\n      req.on('response', this.classicResponseHandler.bind(this, resolve, reject));\n\n      if (this.requestData.options.timeout) {\n        req.on('timeout', this.timeoutErrorHandler.bind(this));\n      } // Debug handlers\n\n\n      if (this.requestData.requestEventDebugHandler) {\n        this.registerRequestEventDebugHandlers(req);\n      }\n\n      if (this.requestData.body) {\n        req.write(this.requestData.body);\n      }\n\n      req.end();\n    });\n  }\n\n  async makeRequestAsStream() {\n    const {\n      req,\n      res,\n      requestData,\n      originalResponse\n    } = await this.makeRequestAndResolveWhenReady();\n    return new TweetStream_1.default(requestData, {\n      req,\n      res,\n      originalResponse\n    });\n  }\n\n  makeRequestAndResolveWhenReady() {\n    this.buildRequest();\n    return new Promise((resolve, reject) => {\n      const req = this.req; // Handle request errors\n\n      req.on('error', this.requestErrorHandler.bind(this, reject));\n      req.on('response', this.streamResponseHandler.bind(this, resolve, reject));\n\n      if (this.requestData.body) {\n        req.write(this.requestData.body);\n      }\n\n      req.end();\n    });\n  }\n\n}\n\nexports.RequestHandlerHelper = RequestHandlerHelper;\nexports.default = RequestHandlerHelper;","map":{"version":3,"names":["__createBinding","Object","create","o","m","k","k2","undefined","desc","getOwnPropertyDescriptor","__esModule","writable","configurable","enumerable","get","defineProperty","__setModuleDefault","v","value","__importStar","mod","result","prototype","hasOwnProperty","call","__importDefault","exports","RequestHandlerHelper","https_1","require","settings_1","TweetStream_1","types_1","zlib","constructor","requestData","requestErrorHandled","responseData","hrefPathname","url","hostname","pathname","isCompressionDisabled","compression","isFormEncodedEndpoint","href","startsWith","createRequestError","error","TwitterApiV2Settings","debug","logger","log","ApiRequestError","request","req","createPartialResponseError","abortClose","res","message","statusCode","ApiPartialResponseError","response","responseError","rawContent","Buffer","concat","toString","formatV1Errors","errors","map","code","join","formatV2Error","title","detail","type","createResponseError","data","rateLimit","_a","headers","errorString","length","ApiResponseError","getResponseDataStream","contentEncoding","trim","toLowerCase","brotli","createBrotliDecompress","flush","constants","BROTLI_OPERATION_FLUSH","finishFlush","pipe","gunzip","createGunzip","Z_SYNC_FLUSH","inflate","createInflate","detectResponseType","_b","includes","getParsedResponse","mode","forceParseMode","asText","JSON","parse","formEntries","item","URLSearchParams","getRateLimitFromResponse","limit","Number","remaining","reset","rateLimitSaver","onSocketEventHandler","reject","socket","on","onSocketCloseHandler","bind","removeAllListeners","Error","requestErrorHandler","requestError","requestEventDebugHandler","timeoutErrorHandler","destroy","classicResponseHandler","resolve","dataStream","chunk","push","onResponseEndHandler","onResponseCloseHandler","e","options","method","aborted","complete","streamResponseHandler","originalResponse","debugRequest","search","searchParams","entries","key","body","buildRequest","auth","username","password","host","port","path","protocol","registerRequestEventDebugHandlers","withError","makeRequest","Promise","timeout","write","end","makeRequestAsStream","makeRequestAndResolveWhenReady","default"],"sources":["/Users/user/Sites/twits_app/twits/node_modules/twitter-api-v2/dist/client-mixins/request-handler.helper.js"],"sourcesContent":["\"use strict\";\nvar __createBinding = (this && this.__createBinding) || (Object.create ? (function(o, m, k, k2) {\n    if (k2 === undefined) k2 = k;\n    var desc = Object.getOwnPropertyDescriptor(m, k);\n    if (!desc || (\"get\" in desc ? !m.__esModule : desc.writable || desc.configurable)) {\n      desc = { enumerable: true, get: function() { return m[k]; } };\n    }\n    Object.defineProperty(o, k2, desc);\n}) : (function(o, m, k, k2) {\n    if (k2 === undefined) k2 = k;\n    o[k2] = m[k];\n}));\nvar __setModuleDefault = (this && this.__setModuleDefault) || (Object.create ? (function(o, v) {\n    Object.defineProperty(o, \"default\", { enumerable: true, value: v });\n}) : function(o, v) {\n    o[\"default\"] = v;\n});\nvar __importStar = (this && this.__importStar) || function (mod) {\n    if (mod && mod.__esModule) return mod;\n    var result = {};\n    if (mod != null) for (var k in mod) if (k !== \"default\" && Object.prototype.hasOwnProperty.call(mod, k)) __createBinding(result, mod, k);\n    __setModuleDefault(result, mod);\n    return result;\n};\nvar __importDefault = (this && this.__importDefault) || function (mod) {\n    return (mod && mod.__esModule) ? mod : { \"default\": mod };\n};\nObject.defineProperty(exports, \"__esModule\", { value: true });\nexports.RequestHandlerHelper = void 0;\nconst https_1 = require(\"https\");\nconst settings_1 = require(\"../settings\");\nconst TweetStream_1 = __importDefault(require(\"../stream/TweetStream\"));\nconst types_1 = require(\"../types\");\nconst zlib = __importStar(require(\"zlib\"));\nclass RequestHandlerHelper {\n    constructor(requestData) {\n        this.requestData = requestData;\n        this.requestErrorHandled = false;\n        this.responseData = [];\n    }\n    /* Request helpers */\n    get hrefPathname() {\n        const url = this.requestData.url;\n        return url.hostname + url.pathname;\n    }\n    isCompressionDisabled() {\n        return !this.requestData.compression || this.requestData.compression === 'identity';\n    }\n    isFormEncodedEndpoint() {\n        return this.requestData.url.href.startsWith('https://api.twitter.com/oauth/');\n    }\n    /* Error helpers */\n    createRequestError(error) {\n        if (settings_1.TwitterApiV2Settings.debug) {\n            settings_1.TwitterApiV2Settings.logger.log('Request error:', error);\n        }\n        return new types_1.ApiRequestError('Request failed.', {\n            request: this.req,\n            error,\n        });\n    }\n    createPartialResponseError(error, abortClose) {\n        const res = this.res;\n        let message = `Request failed with partial response with HTTP code ${res.statusCode}`;\n        if (abortClose) {\n            message += ' (connection abruptly closed)';\n        }\n        else {\n            message += ' (parse error)';\n        }\n        return new types_1.ApiPartialResponseError(message, {\n            request: this.req,\n            response: this.res,\n            responseError: error,\n            rawContent: Buffer.concat(this.responseData).toString(),\n        });\n    }\n    formatV1Errors(errors) {\n        return errors\n            .map(({ code, message }) => `${message} (Twitter code ${code})`)\n            .join(', ');\n    }\n    formatV2Error(error) {\n        return `${error.title}: ${error.detail} (see ${error.type})`;\n    }\n    createResponseError({ res, data, rateLimit, code }) {\n        var _a;\n        if (settings_1.TwitterApiV2Settings.debug) {\n            settings_1.TwitterApiV2Settings.logger.log(`Request failed with code ${code}, data:`, data);\n            settings_1.TwitterApiV2Settings.logger.log('Response headers:', res.headers);\n        }\n        // Errors formatting.\n        let errorString = `Request failed with code ${code}`;\n        if ((_a = data === null || data === void 0 ? void 0 : data.errors) === null || _a === void 0 ? void 0 : _a.length) {\n            const errors = data.errors;\n            if ('code' in errors[0]) {\n                errorString += ' - ' + this.formatV1Errors(errors);\n            }\n            else {\n                errorString += ' - ' + this.formatV2Error(data);\n            }\n        }\n        return new types_1.ApiResponseError(errorString, {\n            code,\n            data,\n            headers: res.headers,\n            request: this.req,\n            response: res,\n            rateLimit,\n        });\n    }\n    /* Response helpers */\n    getResponseDataStream(res) {\n        if (this.isCompressionDisabled()) {\n            return res;\n        }\n        const contentEncoding = (res.headers['content-encoding'] || 'identity').trim().toLowerCase();\n        if (contentEncoding === 'br') {\n            const brotli = zlib.createBrotliDecompress({\n                flush: zlib.constants.BROTLI_OPERATION_FLUSH,\n                finishFlush: zlib.constants.BROTLI_OPERATION_FLUSH,\n            });\n            res.pipe(brotli);\n            return brotli;\n        }\n        if (contentEncoding === 'gzip') {\n            const gunzip = zlib.createGunzip({\n                flush: zlib.constants.Z_SYNC_FLUSH,\n                finishFlush: zlib.constants.Z_SYNC_FLUSH,\n            });\n            res.pipe(gunzip);\n            return gunzip;\n        }\n        if (contentEncoding === 'deflate') {\n            const inflate = zlib.createInflate({\n                flush: zlib.constants.Z_SYNC_FLUSH,\n                finishFlush: zlib.constants.Z_SYNC_FLUSH,\n            });\n            res.pipe(inflate);\n            return inflate;\n        }\n        return res;\n    }\n    detectResponseType(res) {\n        var _a, _b;\n        // Auto parse if server responds with JSON body\n        if (((_a = res.headers['content-type']) === null || _a === void 0 ? void 0 : _a.includes('application/json')) || ((_b = res.headers['content-type']) === null || _b === void 0 ? void 0 : _b.includes('application/problem+json'))) {\n            return 'json';\n        }\n        // f-e oauth token endpoints\n        else if (this.isFormEncodedEndpoint()) {\n            return 'url';\n        }\n        return 'text';\n    }\n    getParsedResponse(res) {\n        const data = this.responseData;\n        const mode = this.requestData.forceParseMode || this.detectResponseType(res);\n        if (mode === 'buffer') {\n            return Buffer.concat(data);\n        }\n        else if (mode === 'text') {\n            return Buffer.concat(data).toString();\n        }\n        else if (mode === 'json') {\n            const asText = Buffer.concat(data).toString();\n            return asText.length ? JSON.parse(asText) : undefined;\n        }\n        else if (mode === 'url') {\n            const asText = Buffer.concat(data).toString();\n            const formEntries = {};\n            for (const [item, value] of new URLSearchParams(asText)) {\n                formEntries[item] = value;\n            }\n            return formEntries;\n        }\n        else {\n            // mode === 'none'\n            return undefined;\n        }\n    }\n    getRateLimitFromResponse(res) {\n        let rateLimit = undefined;\n        if (res.headers['x-rate-limit-limit']) {\n            rateLimit = {\n                limit: Number(res.headers['x-rate-limit-limit']),\n                remaining: Number(res.headers['x-rate-limit-remaining']),\n                reset: Number(res.headers['x-rate-limit-reset']),\n            };\n            if (this.requestData.rateLimitSaver) {\n                this.requestData.rateLimitSaver(rateLimit);\n            }\n        }\n        return rateLimit;\n    }\n    /* Request event handlers */\n    onSocketEventHandler(reject, socket) {\n        socket.on('close', this.onSocketCloseHandler.bind(this, reject));\n    }\n    onSocketCloseHandler(reject) {\n        this.req.removeAllListeners('timeout');\n        const res = this.res;\n        if (res) {\n            // Response ok, res.close/res.end can handle request ending\n            return;\n        }\n        if (!this.requestErrorHandled) {\n            return reject(this.createRequestError(new Error('Socket closed without any information.')));\n        }\n        // else: other situation\n    }\n    requestErrorHandler(reject, requestError) {\n        var _a, _b;\n        (_b = (_a = this.requestData).requestEventDebugHandler) === null || _b === void 0 ? void 0 : _b.call(_a, 'request-error', { requestError });\n        this.requestErrorHandled = true;\n        reject(this.createRequestError(requestError));\n    }\n    timeoutErrorHandler() {\n        this.requestErrorHandled = true;\n        this.req.destroy(new Error('Request timeout.'));\n    }\n    /* Response event handlers */\n    classicResponseHandler(resolve, reject, res) {\n        this.res = res;\n        const dataStream = this.getResponseDataStream(res);\n        // Register the response data\n        dataStream.on('data', chunk => this.responseData.push(chunk));\n        dataStream.on('end', this.onResponseEndHandler.bind(this, resolve, reject));\n        dataStream.on('close', this.onResponseCloseHandler.bind(this, resolve, reject));\n        // Debug handlers\n        if (this.requestData.requestEventDebugHandler) {\n            this.requestData.requestEventDebugHandler('response', { res });\n            res.on('aborted', error => this.requestData.requestEventDebugHandler('response-aborted', { error }));\n            res.on('error', error => this.requestData.requestEventDebugHandler('response-error', { error }));\n            res.on('close', () => this.requestData.requestEventDebugHandler('response-close', { data: this.responseData }));\n            res.on('end', () => this.requestData.requestEventDebugHandler('response-end'));\n        }\n    }\n    onResponseEndHandler(resolve, reject) {\n        const rateLimit = this.getRateLimitFromResponse(this.res);\n        let data;\n        try {\n            data = this.getParsedResponse(this.res);\n        }\n        catch (e) {\n            reject(this.createPartialResponseError(e, false));\n            return;\n        }\n        // Handle bad error codes\n        const code = this.res.statusCode;\n        if (code >= 400) {\n            reject(this.createResponseError({ data, res: this.res, rateLimit, code }));\n            return;\n        }\n        if (settings_1.TwitterApiV2Settings.debug) {\n            settings_1.TwitterApiV2Settings.logger.log(`[${this.requestData.options.method} ${this.hrefPathname}]: Request succeeds with code ${this.res.statusCode}`);\n            settings_1.TwitterApiV2Settings.logger.log('Response body:', data);\n        }\n        resolve({\n            data,\n            headers: this.res.headers,\n            rateLimit,\n        });\n    }\n    onResponseCloseHandler(resolve, reject) {\n        const res = this.res;\n        if (res.aborted) {\n            // Try to parse the request (?)\n            try {\n                this.getParsedResponse(this.res);\n                // Ok, try to resolve normally the request\n                return this.onResponseEndHandler(resolve, reject);\n            }\n            catch (e) {\n                // Parse error, just drop with content\n                return reject(this.createPartialResponseError(e, true));\n            }\n        }\n        if (!res.complete) {\n            return reject(this.createPartialResponseError(new Error('Response has been interrupted before response could be parsed.'), true));\n        }\n        // else: end has been called\n    }\n    streamResponseHandler(resolve, reject, res) {\n        const code = res.statusCode;\n        if (code < 400) {\n            if (settings_1.TwitterApiV2Settings.debug) {\n                settings_1.TwitterApiV2Settings.logger.log(`[${this.requestData.options.method} ${this.hrefPathname}]: Request succeeds with code ${res.statusCode} (starting stream)`);\n            }\n            const dataStream = this.getResponseDataStream(res);\n            // HTTP code ok, consume stream\n            resolve({ req: this.req, res: dataStream, originalResponse: res, requestData: this.requestData });\n        }\n        else {\n            // Handle response normally, can only rejects\n            this.classicResponseHandler(() => undefined, reject, res);\n        }\n    }\n    /* Wrappers for request lifecycle */\n    debugRequest() {\n        const url = this.requestData.url;\n        settings_1.TwitterApiV2Settings.logger.log(`[${this.requestData.options.method} ${this.hrefPathname}]`, this.requestData.options);\n        if (url.search) {\n            settings_1.TwitterApiV2Settings.logger.log('Request parameters:', [...url.searchParams.entries()].map(([key, value]) => `${key}: ${value}`));\n        }\n        if (this.requestData.body) {\n            settings_1.TwitterApiV2Settings.logger.log('Request body:', this.requestData.body);\n        }\n    }\n    buildRequest() {\n        var _a;\n        const url = this.requestData.url;\n        const auth = url.username ? `${url.username}:${url.password}` : undefined;\n        const headers = (_a = this.requestData.options.headers) !== null && _a !== void 0 ? _a : {};\n        if (this.requestData.compression === true || this.requestData.compression === 'brotli') {\n            headers['accept-encoding'] = 'br;q=1.0, gzip;q=0.8, deflate;q=0.5, *;q=0.1';\n        }\n        else if (this.requestData.compression === 'gzip') {\n            headers['accept-encoding'] = 'gzip;q=1, deflate;q=0.5, *;q=0.1';\n        }\n        else if (this.requestData.compression === 'deflate') {\n            headers['accept-encoding'] = 'deflate;q=1, *;q=0.1';\n        }\n        if (settings_1.TwitterApiV2Settings.debug) {\n            this.debugRequest();\n        }\n        this.req = (0, https_1.request)({\n            ...this.requestData.options,\n            // Define URL params manually, addresses dependencies error https://github.com/PLhery/node-twitter-api-v2/issues/94\n            host: url.hostname,\n            port: url.port || undefined,\n            path: url.pathname + url.search,\n            protocol: url.protocol,\n            auth,\n            headers,\n        });\n    }\n    registerRequestEventDebugHandlers(req) {\n        req.on('close', () => this.requestData.requestEventDebugHandler('close'));\n        req.on('abort', () => this.requestData.requestEventDebugHandler('abort'));\n        req.on('socket', socket => {\n            this.requestData.requestEventDebugHandler('socket', { socket });\n            socket.on('error', error => this.requestData.requestEventDebugHandler('socket-error', { socket, error }));\n            socket.on('connect', () => this.requestData.requestEventDebugHandler('socket-connect', { socket }));\n            socket.on('close', withError => this.requestData.requestEventDebugHandler('socket-close', { socket, withError }));\n            socket.on('end', () => this.requestData.requestEventDebugHandler('socket-end', { socket }));\n            socket.on('lookup', (...data) => this.requestData.requestEventDebugHandler('socket-lookup', { socket, data }));\n            socket.on('timeout', () => this.requestData.requestEventDebugHandler('socket-timeout', { socket }));\n        });\n    }\n    makeRequest() {\n        this.buildRequest();\n        return new Promise((resolve, reject) => {\n            const req = this.req;\n            // Handle request errors\n            req.on('error', this.requestErrorHandler.bind(this, reject));\n            req.on('socket', this.onSocketEventHandler.bind(this, reject));\n            req.on('response', this.classicResponseHandler.bind(this, resolve, reject));\n            if (this.requestData.options.timeout) {\n                req.on('timeout', this.timeoutErrorHandler.bind(this));\n            }\n            // Debug handlers\n            if (this.requestData.requestEventDebugHandler) {\n                this.registerRequestEventDebugHandlers(req);\n            }\n            if (this.requestData.body) {\n                req.write(this.requestData.body);\n            }\n            req.end();\n        });\n    }\n    async makeRequestAsStream() {\n        const { req, res, requestData, originalResponse } = await this.makeRequestAndResolveWhenReady();\n        return new TweetStream_1.default(requestData, { req, res, originalResponse });\n    }\n    makeRequestAndResolveWhenReady() {\n        this.buildRequest();\n        return new Promise((resolve, reject) => {\n            const req = this.req;\n            // Handle request errors\n            req.on('error', this.requestErrorHandler.bind(this, reject));\n            req.on('response', this.streamResponseHandler.bind(this, resolve, reject));\n            if (this.requestData.body) {\n                req.write(this.requestData.body);\n            }\n            req.end();\n        });\n    }\n}\nexports.RequestHandlerHelper = RequestHandlerHelper;\nexports.default = RequestHandlerHelper;\n"],"mappings":"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"},"metadata":{},"sourceType":"script"}